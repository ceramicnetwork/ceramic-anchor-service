# org: ukstv
# app: aws-node-http-api-project
# Comment out above to deploy to your own infra

service: cas-did-auth
frameworkVersion: '3'
useDotenv: true

plugins:
  - serverless-esbuild
  - serverless-lift
  - serverless-offline

custom:
  region: us-east-2
  esbuild:
    minify: true
    watch:
      # anymatch-compatible definition (https://github.com/es128/anymatch)
      pattern: ['./index.ts', 'src/**/*.ts'] # default .
      ignore: ['.serverless/**/*', '.build'] # default ['.build', 'dist', 'node_modules']

provider:
  name: aws
  region: ${opt:region, self:custom.region}
  runtime: nodejs16.x
  memorySize: 2048
  apiGateway:
    restApiId: ${env:REST_API_ID}
    restApiRootResourceId: ${env:REST_API_ROOT_RESOURCE_ID}
    description: 'Provisioned in Terraform'

constructs:
  didDb:
    type: database/dynamodb-single-table
    gsiCount: 1
  otpDb:
    type: database/dynamodb-single-table
    gsiCount: 1

functions:
  api:
    handler: src/handlers/api.handler
    events:
      - http:
          method: 'any'
          path: '/api/v0/auth/{proxy+}'
    environment:
      DB_DID_TABLE_NAME: ${construct:didDb.tableName}
      DB_OTP_TABLE_NAME: ${construct:otpDb.tableName}
  apiAuthorizer:
    handler: src/authorizers/api.handler

resources:
  Resources:
    Authorizer:
      Type: AWS::ApiGateway::Authorizer
      Properties:
        Name: DIDAuth
        RestApiId: ${env:REST_API_ID}
        Type: REQUEST
        IdentitySource: method.request.header.Authorization
        AuthorizerResultTtlInSeconds: 0
        AuthorizerUri:
          Fn::Join: [ "",
            [
              "arn:aws:apigateway:",
              "${self:custom.region}",
              ":lambda:path/",
              "2015-03-31/functions/",
              Fn::GetAtt: ["ApiAuthorizerLambdaFunction", "Arn" ],
              "/invocations"
            ]]
    apiGatewayLambdaPermissions:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName:
          Fn::GetAtt: [ ApiAuthorizerLambdaFunction, Arn]
        Action: lambda:InvokeFunction
        Principal:
          Fn::Join: [ "",
          [
            "apigateway.",
            Ref: AWS::URLSuffix
          ]]
